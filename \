var InMemoryPersistence = function() {
  this.scores = {}
  this.rounds = []
  this.users = {}
  process.on('message', this.onMessage.bind(this))
}

InMemoryPersistence.prototype = {
  getGlobalScoreForPlayer: function(id, cb) {
    var score = this.scores[id] || 0
    process.nextTick(function() {
      cb(score)
    })
  },
  setGlobalScoreForPlayer: function(id, score, cb) {
    this.scores[id] = score
    if(cb) process.nextTick(cb)
  },
  createRound: function(player, cb) {
    this.rounds.push({
      player: player,
      events: []
    })
    var id = this.rounds.length
    process.nextTick(function(){ 
      cb(id)
    })
  },
  getRound: function(id, cb) {

  },
  logDrawEvent: function(roundId, ev) {
    this.rounds[roundId].events.push(ev)
  },
  savePlayer: function(id, data) {
    this.users[id] = data
  },
  getPlayer: function(id, cb) {
    cb(this.users[id])
  },
  onMessage: function(msg) {
    var handler = this['handle' + msg.command]    
    if(handler)
      handler.call(this, msg)
  },
  handleSetGlobalScore: function(msg) {
    this.scores[msg.userid] = msg.score
  }
}


module.exports = InMemoryPersistence
