<DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css"></link>
    <script src="jquery.js"></script>
    <script src="hammer.js"></script>
    <script src="jquery.hammer.js"></script>
    <script src="socket.io/socket.io.js"></script>
    <script type="text/javascript">


      var canvas = null
      ,   context = null
      ,   actions = {}
      ,   colours = {}
      ,   clientCount = null
      ,   clientStatus = null
      ,   clientInput = null
      ,   clientInputButton = null
      ,   clientFeedback = null
      ,   game = null

      function colourForIndex(index) {
        if(colours[index]) return colours[index]
        colours[index] = '#'+Math.floor(Math.random()*16777215).toString(16)
        return colours[index]
      }

      function drawLine(from, to, index) {
        context.strokeStyle = colourForIndex(index)
        context.beginPath()
        context.moveTo(from.x, from.y)
        context.lineTo(to.x, to.y)
        context.stroke()
      }

      var commandHandlers = {
        'start': function(position, index) {
          actions[index] = position
        },
        'move': function(position, index) {
          var oldPosition = actions[index]
          drawLine(oldPosition, position, index)
          actions[index] = position
        },
        'end': function(position, index) {
          delete actions[index]
        }
      }

      function dispatch(command, data) {
        var handler = commandHandlers[command]
        handler(data, 0)
        socket.emit('command', {
          name: command,
          data: data
         })
      }

      function onDragStart(ev) {
        dispatch('start', ev.position)
      }

      function onDrag(ev) {
        dispatch('move', ev.position)
      }

      function onDragEnd(ev) {
        dispatch('end', ev.position)
      }

      function createDrawingContext(id) {
        //canvas = document.getElementById(id)
        //context = canvas.getContext('2d')
      }

      function hookEventsFromCanvas(id) {
        //try {
        //$('#' + id)
        //  .hammer({
        //  //  prevent_default: true   
        //   })
        //  //.on({
        //  //  dragstart: onDragStart,
        //  //  drag: onDrag,
        //  //  dragend: onDragEnd
        //  //  })

        //} catch(ex) {
        //  console.log(ex)
        //}
      }

      var onServerCommand = function(data) {
        commandHandlers[data.name](data.data, data.sender) 
      }

      var setStatusWaiting = function() {
        clientStatus.text('Waiting for other players to join')
      }

      var setStatusDrawing = function(word) {
        clientStatus.text('Drawing the word ' + word)
        status = 'drawing'
      }

      var setStatusGuessing = function() {
        clientStatus.text('Guessing what the other player is drawing')
        status = 'guessing'
      }

      var notifyAsOnlyPlayer = function() {
        clientCount.text('You are the only player, invite your friends to join')
        status = 'waiting'
      }

      var updatePlayerCount = function(count) {
        clientCount.text('There are ' + count + ' players connected')
      }

      var onServerStatus = function(data) {
        switch(data.status) {
          case 'waiting':
            setStatusWaiting()
            break
          case 'drawing':
            setStatusDrawing(data.word)
            break
          case 'guessing':
            setStatusGuessing()
            break
          default:
            break
        }

        if(data.clientCount === 1)
          notifyAsOnlyPlayer()
        else 
          updatePlayerCount(data.clientCount)
      }
    
      var onWrongGuess = function(word) {
         clientFeedback.append(
           $('<p/>').text(word + ' is not the word')
         )
      }

      function onCorrectGuess(word) {
        clientFeedback.append( 
          $('<p/>').text(word + ' was correct!')
        )
      }


      function onGoodDrawing(word) {
        clientFeedback.append(
          $('<p/>').text(word + 'was guessed correctly')
        )
      }

      function onRoundEnded(data) {
        if(status === 'guessing')
          onCorrectGuess(data.word)
        else if(status === 'drawing')
          onGoodDrawing(data.word)
      } 

      function closeSockets() {
        game.stop()
      }

      function submitWord() {
        var word = clientInput.val()
        clientInput.val('')
        game.submitWord(word)
      }

      function hookEventsForInput() {
        clientInputButton.click(submitWord)
      }

      $(document).ready(function() {
        clientCount = $('#client-count')
        clientStatus = $('#client-status')
        clientInput = $('#client-input')
        clientInputButton = $('#client-input-button')
        clientFeedback = $('#client-feedback')
        hookEventsFromCanvas('surface')
        hookEventsForInput()
        createDrawingContext('surface')
        game = new Game()
        game.start()
      })
    </script>
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  </head>
  <body>
    <canvas id="surface" width="800" height="600">
      Your browser doesn't support Canvas wtf dude?
    </canvas>
    <input type="text" id="client-input"/><input type="button" value="Submit" id="client-input-button"/>
    <div id="client-count"></div>
    <div id="client-status"></div>
    <div id="client-feedback"></div>
  </body>
</html>
